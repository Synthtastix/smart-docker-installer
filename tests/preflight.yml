name: Preflight â€” S.M.A.R.T Docker Installer v2.3

on:
  workflow_dispatch:
  pull_request:
  push:
    branches: [ main, master ]

jobs:
  preflight:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Show versions
        run: |
          node -v
          npm -v
          docker -v || true
          docker compose version || true

      - name: Install dependencies (if any)
        run: |
          if [ -f package.json ]; then npm ci; fi

      - name: Doctor (dry verification)
        run: |
          node stacklink-smart_public_v2.3.js --doctor --log-json || true
          node stacklink-smart_public_v2.3.js --config smart.config.json --verify-only --log-json || true

      - name: Smoke test (local)
        run: |
          chmod +x ./smoke_test_local.sh
          ./smoke_test_local.sh

      - name: Archive artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: smart-preflight-artifacts
          path: |
            ./.state/**
            ./state/**
            ./logs/**
            ./reports/**
          if-no-files-found: ignore
